# GitHub Actions - Security Audit Workflow
# Ce workflow s'exÃ©cute sur les Pull Requests et les push sur main/master
# Il bloque le merge si des vulnÃ©rabilitÃ©s HIGH ou CRITICAL sont dÃ©tectÃ©es

name: ðŸ”’ Security Audit

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Permet l'exÃ©cution manuelle

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12', '3.13']
      fail-fast: false  # Continue avec Python 3.13 mÃªme si 3.12 Ã©choue
    
    steps:
    # Checkout du code
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # NÃ©cessaire pour TruffleHog (scan de l'historique)
    
    # Setup Python
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    # Cache pour les outils de sÃ©curitÃ©
    - name: Cache security tools
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-security-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-security-
    
    # Installation des dÃ©pendances
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pip-audit
        pip install django django-security django-csp django-defender
        pip install detect-secrets truffleHog3
        # Semgrep n'est pas compatible avec Python 3.12, uniquement 3.13+
        if [ "${{ matrix.python-version }}" == "3.13" ]; then
          pip install semgrep
        fi
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
    
    # CrÃ©ation du dossier de rapports
    - name: Create reports directory
      run: mkdir -p security-reports
    
    # ============================================================================
    # SCAN 1: Bandit (Analyse statique Python)
    # ============================================================================
    - name: ðŸ” Run Bandit Security Scan
      id: bandit
      continue-on-error: true
      run: |
        echo "::group::Bandit Security Scan"
        bandit -r . \
          -x ./tests,./migrations,./env,./venv,./.git,./__pycache__,./.pytest_cache \
          -f json \
          -o security-reports/bandit-report-py${{ matrix.python-version }}.json \
          || true
        
        # GÃ©nÃ©rer aussi un rapport texte pour le log
        bandit -r . \
          -x ./tests,./migrations,./env,./venv,./.git,./__pycache__,./.pytest_cache \
          -f txt \
          -o security-reports/bandit-report-py${{ matrix.python-version }}.txt \
          || true
        
        cat security-reports/bandit-report-py${{ matrix.python-version }}.txt
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 2: Semgrep (Analyse avancÃ©e avec rÃ¨gles de sÃ©curitÃ©)
    # ============================================================================
    - name: ðŸ” Run Semgrep Security Scan
      id: semgrep
      continue-on-error: true
      # Semgrep n'est pas compatible avec Python 3.12
      if: matrix.python-version == '3.13'
      run: |
        echo "::group::Semgrep Security Scan"
        semgrep --config=p/python \
                --config=p/django \
                --config=p/security-audit \
                --config=p/owasp-top-ten \
                --json \
                --output=security-reports/semgrep-report-py${{ matrix.python-version }}.json \
                . || true
        
        # GÃ©nÃ©rer aussi un rapport SARIF pour GitHub Security tab
        semgrep --config=p/python \
                --config=p/django \
                --config=p/security-audit \
                --sarif \
                --output=security-reports/semgrep-report-py${{ matrix.python-version }}.sarif \
                . || true
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 3: Safety (VulnÃ©rabilitÃ©s des dÃ©pendances)
    # ============================================================================
    - name: ðŸ” Run Safety Check
      id: safety
      continue-on-error: true
      run: |
        echo "::group::Safety Dependency Check"
        safety check --json --output security-reports/safety-report-py${{ matrix.python-version }}.json || true
        
        # GÃ©nÃ©rer aussi un rapport texte
        safety check --full-report --output security-reports/safety-report-py${{ matrix.python-version }}.txt || true
        cat security-reports/safety-report-py${{ matrix.python-version }}.txt || echo "Safety report not generated"
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 4: Pip-audit (Audit PyPI)
    # ============================================================================
    - name: ðŸ” Run Pip-audit
      id: pip-audit
      continue-on-error: true
      run: |
        echo "::group::Pip-audit"
        pip-audit --desc --format=json --output=security-reports/pip-audit-report-py${{ matrix.python-version }}.json || true
        
        # GÃ©nÃ©rer aussi un rapport texte
        pip-audit --desc --format=markdown --output=security-reports/pip-audit-report-py${{ matrix.python-version }}.md || true
        cat security-reports/pip-audit-report-py${{ matrix.python-version }}.md || echo "Pip-audit report not generated"
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 5: Detect-secrets (DÃ©tection de secrets)
    # ============================================================================
    - name: ðŸ” Run Detect-secrets
      id: detect-secrets
      continue-on-error: true
      run: |
        echo "::group::Detect-secrets Scan"
        
        # CrÃ©er le baseline s'il n'existe pas
        if [ ! -f .secrets.baseline ]; then
          echo "Creating new secrets baseline..."
          detect-secrets scan --all-files --baseline .secrets.baseline
        fi
        
        # Scan avec le baseline
        detect-secrets scan --baseline .secrets.baseline --all-files > security-reports/detect-secrets-report-py${{ matrix.python-version }}.json || true
        
        # VÃ©rifier s'il y a des secrets non auditÃ©s
        detect-secrets audit --report --json .secrets.baseline > security-reports/detect-secrets-audit-py${{ matrix.python-version }}.json || true
        
        # Afficher les rÃ©sultats
        detect-secrets audit --report .secrets.baseline || true
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 6: TruffleHog (Scan approfondi des secrets)
    # ============================================================================
    - name: ðŸ” Run TruffleHog
      id: trufflehog
      continue-on-error: true
      run: |
        echo "::group::TruffleHog Scan"
        truffleHog3 --json --output security-reports/trufflehog-report-py${{ matrix.python-version }}.json . || true
        
        # Scan avec plus de dÃ©tails
        truffleHog3 --json --output security-reports/trufflehog-detailed-py${{ matrix.python-version }}.json --rules .truffleHog3.yml . || true
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 7: Django Security Check
    # ============================================================================
    - name: ðŸ” Run Django Security Check
      id: django-security
      continue-on-error: true
      run: |
        echo "::group::Django Security Check"
        
        # VÃ©rifier si c'est un projet Django
        if [ -f "manage.py" ]; then
          python manage.py check --deploy --verbosity=2 > security-reports/django-security-check-py${{ matrix.python-version }}.txt 2>&1 || true
          cat security-reports/django-security-check-py${{ matrix.python-version }}.txt
        else
          echo "Pas de fichier manage.py trouvÃ© - Skip Django security check"
        fi
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 8: Pylint Security
    # ============================================================================
    - name: ðŸ” Run Pylint Security
      id: pylint-security
      continue-on-error: true
      run: |
        echo "::group::Pylint Security"
        pip install pylint-security
        pylint --load-plugins=pylint_security --output-format=json . > security-reports/pylint-security-report-py${{ matrix.python-version }}.json 2>/dev/null || true
        
        # GÃ©nÃ©rer aussi un rapport texte
        pylint --load-plugins=pylint_security --output-format=text . > security-reports/pylint-security-report-py${{ matrix.python-version }}.txt 2>/dev/null || true
        cat security-reports/pylint-security-report-py${{ matrix.python-version }}.txt || echo "Pylint security report not generated"
        echo "::endgroup::"
    
    # ============================================================================
    # SCAN 9: JavaScript/Node (si package.json existe)
    # ============================================================================
    - name: ðŸ” Run NPM Audit
      id: npm-audit
      continue-on-error: true
      if: hashFiles('package.json') != ''
      run: |
        echo "::group::NPM Audit"
        if [ -f "package.json" ]; then
          npm audit --json > security-reports/npm-audit-report-py${{ matrix.python-version }}.json 2>&1 || true
          npm audit --audit-level=high || true
        fi
        echo "::endgroup::"
    
    # ============================================================================
    # GÃ‰NÃ‰RATION DU RAPPORT GLOBAL
    # ============================================================================
    - name: ðŸ“Š Generate Security Summary Report
      id: summary
      run: |
        echo "::group::Generating Security Summary"
        
        python3 << 'EOF'
        import json
        import os
        from datetime import datetime
        import glob

        def count_severity_bandit(filepath):
            """Compte les sÃ©vÃ©ritÃ©s dans le rapport Bandit"""
            try:
                with open(filepath, 'r') as f:
                    data = json.load(f)
                results = data.get('results', [])
                counts = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}
                for issue in results:
                    severity = issue.get('issue_severity', 'LOW')
                    counts[severity] = counts.get(severity, 0) + 1
                return counts
            except:
                return {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}

        def count_severity_semgrep(filepath):
            """Compte les sÃ©vÃ©ritÃ©s dans le rapport Semgrep"""
            try:
                with open(filepath, 'r') as f:
                    data = json.load(f)
                results = data.get('results', [])
                counts = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}
                for issue in results:
                    severity = issue.get('extra', {}).get('severity', 'LOW')
                    if severity == 'ERROR':
                        severity = 'HIGH'
                    elif severity == 'WARNING':
                        severity = 'MEDIUM'
                    counts[severity] = counts.get(severity, 0) + 1
                return counts
            except:
                return {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}

        def count_severity_safety(filepath):
            """Compte les vulnÃ©rabilitÃ©s dans le rapport Safety"""
            try:
                with open(filepath, 'r') as f:
                    data = json.load(f)
                vulnerabilities = data if isinstance(data, list) else []
                counts = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}
                for vuln in vulnerabilities:
                    severity = vuln.get('severity', 'LOW')
                    counts[severity] = counts.get(severity, 0) + 1
                return counts
            except:
                return {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}

        # GÃ©nÃ©rer le rapport Markdown
        report = []
        report.append("# ðŸ”’ Rapport de SÃ©curitÃ© - Audit Complet")
        report.append(f"\n**Date** : {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        report.append(f"**Python Version** : ${{ matrix.python-version }}")
        report.append(f"**Commit** : ${{ github.sha }}")
        report.append(f"**Branch** : ${{ github.ref }}")
        report.append("")
        report.append("## ðŸ“Š RÃ©sumÃ© des VulnÃ©rabilitÃ©s")
        report.append("")
        report.append("| Outil | CRITICAL | HIGH | MEDIUM | LOW |")
        report.append("|-------|----------|------|--------|-----|")

        # Analyser les rapports
        py_version = "${{ matrix.python-version }}"
        
        bandit_counts = count_severity_bandit(f'security-reports/bandit-report-py{py_version}.json')
        report.append(f"| Bandit | {bandit_counts['CRITICAL']} | {bandit_counts['HIGH']} | {bandit_counts['MEDIUM']} | {bandit_counts['LOW']} |")
        
        # Semgrep n'est exÃ©cutÃ© que sur Python 3.13
        if py_version == "3.13":
            semgrep_counts = count_severity_semgrep(f'security-reports/semgrep-report-py{py_version}.json')
            report.append(f"| Semgrep | {semgrep_counts['CRITICAL']} | {semgrep_counts['HIGH']} | {semgrep_counts['MEDIUM']} | {semgrep_counts['LOW']} |")
        else:
            report.append(f"| Semgrep | N/A | N/A | N/A | N/A | (Python 3.13 only)")
        
        safety_counts = count_severity_safety(f'security-reports/safety-report-py{py_version}.json')
        report.append(f"| Safety | {safety_counts['CRITICAL']} | {safety_counts['HIGH']} | {safety_counts['MEDIUM']} | {safety_counts['LOW']} |")

        report.append("")
        
        # Calculer le total (seulement si semgrep a Ã©tÃ© exÃ©cutÃ©)
        if py_version == "3.13":
            total_critical = bandit_counts['CRITICAL'] + semgrep_counts['CRITICAL'] + safety_counts['CRITICAL']
            total_high = bandit_counts['HIGH'] + semgrep_counts['HIGH'] + safety_counts['HIGH']
        else:
            total_critical = bandit_counts['CRITICAL'] + safety_counts['CRITICAL']
            total_high = bandit_counts['HIGH'] + safety_counts['HIGH']
        
        report.append(f"**Total CRITICAL** : {total_critical}")
        report.append(f"**Total HIGH** : {total_high}")
        report.append("")

        if total_critical > 0 or total_high > 0:
            report.append("## ðŸš¨ ALERTE SÃ‰CURITÃ‰")
            report.append("")
            report.append("âš ï¸ **Des vulnÃ©rabilitÃ©s CRITICAL ou HIGH ont Ã©tÃ© dÃ©tectÃ©es !**")
            report.append("")
            report.append("**Action requise** : Corriger ces vulnÃ©rabilitÃ©s avant de merger.")
            report.append("")
            
            # Ã‰crire dans un fichier pour le job suivant
            with open('security-reports/SECURITY_FAILURE', 'w') as f:
                f.write('FAILURE')
        else:
            report.append("## âœ… STATUT")
            report.append("")
            report.append("Aucune vulnÃ©rabilitÃ© CRITICAL ou HIGH dÃ©tectÃ©e.")
            report.append("")
            
            with open('security-reports/SECURITY_SUCCESS', 'w') as f:
                f.write('SUCCESS')

        report.append("")
        report.append("## ðŸ“ Rapports DÃ©taillÃ©s")
        report.append("")
        report.append("Les rapports complets sont disponibles dans les artifacts de ce workflow.")
        report.append("")
        report.append("### Fichiers gÃ©nÃ©rÃ©s :")
        report.append("- `bandit-report-py{py_version}.json` - Analyse statique Python")
        if py_version == "3.13":
            report.append("- `semgrep-report-py{py_version}.json` - Analyse avancÃ©e")
        report.append("- `safety-report-py{py_version}.json` - VulnÃ©rabilitÃ©s dÃ©pendances")
        report.append("- `pip-audit-report-py{py_version}.json` - Audit PyPI")
        report.append("- `detect-secrets-report-py{py_version}.json` - DÃ©tection de secrets")
        report.append("- `trufflehog-report-py{py_version}.json` - Scan approfondi secrets")
        report.append("- `django-security-check-py{py_version}.txt` - Check Django")
        report.append("")
        report.append("---")
        report.append("")
        report.append("Pour plus d'informations, consultez le skill de sÃ©curitÃ© : `workflows/security-audit.md`")

        # Ã‰crire le rapport
        with open(f'security-reports/SECURITY_REPORT_PY{py_version.replace(".", "")}.md', 'w') as f:
            f.write('\n'.join(report))

        # Afficher le rapport
        print('\n'.join(report))
        EOF
        
        echo "::endgroup::"
    
    # ============================================================================
    # UPLOAD DES ARTIFACTS
    # ============================================================================
    - name: ðŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-py${{ matrix.python-version }}
        path: security-reports/
        retention-days: 30
    
    # ============================================================================
    # VÃ‰RIFICATION FINALE - BLOCAGE SI VULNÃ‰RABILITÃ‰S CRITICAL/HIGH
    # ============================================================================
    - name: ðŸš« Check for CRITICAL/HIGH Vulnerabilities
      run: |
        if [ -f "security-reports/SECURITY_FAILURE" ]; then
          echo "âŒ Ã‰CHEC : Des vulnÃ©rabilitÃ©s CRITICAL ou HIGH ont Ã©tÃ© dÃ©tectÃ©es !"
          echo ""
          echo "Consultez les rapports dans les artifacts pour plus de dÃ©tails."
          echo ""
          echo "Action requise : Corriger les vulnÃ©rabilitÃ©s avant de merger cette PR."
          exit 1
        else
          echo "âœ… SUCCÃˆS : Aucune vulnÃ©rabilitÃ© CRITICAL ou HIGH dÃ©tectÃ©e."
        fi

  # ============================================================================
  # JOB DE SYNTHÃˆSE (Combine les rÃ©sultats des deux versions Python)
  # ============================================================================
  security-summary:
    name: Security Summary
    needs: security-audit
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-reports
        pattern: security-reports-py*
    
    - name: ðŸ“ Generate Final Summary
      run: |
        echo "# ðŸ”’ Security Audit Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Python Versions Tested" >> $GITHUB_STEP_SUMMARY
        echo "- Python 3.12" >> $GITHUB_STEP_SUMMARY
        echo "- Python 3.13" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # VÃ©rifier si des Ã©checs ont eu lieu
        if [ "${{ needs.security-audit.result }}" == "failure" ]; then
          echo "## ðŸš« Status: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Des vulnÃ©rabilitÃ©s CRITICAL ou HIGH ont Ã©tÃ© dÃ©tectÃ©es !**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action requise** : Corriger les vulnÃ©rabilitÃ©s avant de merger." >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "## âœ… Status: PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Aucune vulnÃ©rabilitÃ© CRITICAL ou HIGH dÃ©tectÃ©e." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“ Rapports" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Les rapports dÃ©taillÃ©s sont disponibles dans les artifacts." >> $GITHUB_STEP_SUMMARY
